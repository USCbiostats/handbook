<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>7 HPC | USC biostats R Handbook</title>
  <meta name="description" content="Working document description best practices and coding standard used in the USC Biostats department.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="7 HPC | USC biostats R Handbook" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Working document description best practices and coding standard used in the USC Biostats department." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 HPC | USC biostats R Handbook" />
  
  <meta name="twitter:description" content="Working document description best practices and coding standard used in the USC Biostats department." />
  

<meta name="author" content="Emil Hvitfeldt">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="profile-benchmark.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Handbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#add-chapter"><i class="fa fa-check"></i><b>1.1</b> add chapter</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#editing-a-chapter"><i class="fa fa-check"></i><b>1.2</b> editing a chapter</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#compile-handbook"><i class="fa fa-check"></i><b>1.3</b> compile handbook</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="coding-standards.html"><a href="coding-standards.html"><i class="fa fa-check"></i><b>2</b> Coding Standards</a><ul>
<li class="chapter" data-level="2.1" data-path="coding-standards.html"><a href="coding-standards.html#general-overview"><i class="fa fa-check"></i><b>2.1</b> General overview</a></li>
<li class="chapter" data-level="2.2" data-path="coding-standards.html"><a href="coding-standards.html#helpful-suggestions"><i class="fa fa-check"></i><b>2.2</b> Helpful suggestions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="building-a-r-package.html"><a href="building-a-r-package.html"><i class="fa fa-check"></i><b>3</b> Building a R package</a><ul>
<li class="chapter" data-level="3.1" data-path="building-a-r-package.html"><a href="building-a-r-package.html#motivation"><i class="fa fa-check"></i><b>3.1</b> Motivation</a></li>
<li class="chapter" data-level="3.2" data-path="building-a-r-package.html"><a href="building-a-r-package.html#preparation"><i class="fa fa-check"></i><b>3.2</b> Preparation</a><ul>
<li class="chapter" data-level="3.2.1" data-path="building-a-r-package.html"><a href="building-a-r-package.html#naming-your-r-package"><i class="fa fa-check"></i><b>3.2.1</b> Naming your R package</a></li>
<li class="chapter" data-level="3.2.2" data-path="building-a-r-package.html"><a href="building-a-r-package.html#checking"><i class="fa fa-check"></i><b>3.2.2</b> Checking</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="building-a-r-package.html"><a href="building-a-r-package.html#minimal-r-package"><i class="fa fa-check"></i><b>3.3</b> Minimal R Package</a></li>
<li class="chapter" data-level="3.4" data-path="building-a-r-package.html"><a href="building-a-r-package.html#additional-components"><i class="fa fa-check"></i><b>3.4</b> Additional Components</a><ul>
<li class="chapter" data-level="3.4.1" data-path="building-a-r-package.html"><a href="building-a-r-package.html#r-code-r"><i class="fa fa-check"></i><b>3.4.1</b> R code <code>R/</code></a></li>
<li class="chapter" data-level="3.4.2" data-path="building-a-r-package.html"><a href="building-a-r-package.html#documentation"><i class="fa fa-check"></i><b>3.4.2</b> Documentation</a></li>
<li class="chapter" data-level="3.4.3" data-path="building-a-r-package.html"><a href="building-a-r-package.html#dependencies"><i class="fa fa-check"></i><b>3.4.3</b> Dependencies</a></li>
<li class="chapter" data-level="3.4.4" data-path="building-a-r-package.html"><a href="building-a-r-package.html#license"><i class="fa fa-check"></i><b>3.4.4</b> License</a></li>
<li class="chapter" data-level="3.4.5" data-path="building-a-r-package.html"><a href="building-a-r-package.html#readme"><i class="fa fa-check"></i><b>3.4.5</b> README</a></li>
<li class="chapter" data-level="3.4.6" data-path="building-a-r-package.html"><a href="building-a-r-package.html#tests"><i class="fa fa-check"></i><b>3.4.6</b> Tests</a></li>
<li class="chapter" data-level="3.4.7" data-path="building-a-r-package.html"><a href="building-a-r-package.html#data"><i class="fa fa-check"></i><b>3.4.7</b> Data</a></li>
<li class="chapter" data-level="3.4.8" data-path="building-a-r-package.html"><a href="building-a-r-package.html#compiledcode"><i class="fa fa-check"></i><b>3.4.8</b> Compiled code</a></li>
<li class="chapter" data-level="3.4.9" data-path="building-a-r-package.html"><a href="building-a-r-package.html#vignettes"><i class="fa fa-check"></i><b>3.4.9</b> vignettes</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="building-a-r-package.html"><a href="building-a-r-package.html#resources"><i class="fa fa-check"></i><b>3.5</b> Resources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="parallel-computing.html"><a href="parallel-computing.html"><i class="fa fa-check"></i><b>4</b> Parallel computing</a><ul>
<li class="chapter" data-level="4.1" data-path="parallel-computing.html"><a href="parallel-computing.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="parallel-computing.html"><a href="parallel-computing.html#what-is-parallel-computing-anyway"><i class="fa fa-check"></i><b>4.2</b> What is parallel computing, anyway?</a></li>
<li class="chapter" data-level="4.3" data-path="parallel-computing.html"><a href="parallel-computing.html#when-is-it-a-good-idea"><i class="fa fa-check"></i><b>4.3</b> When is it a good idea?</a></li>
<li class="chapter" data-level="4.4" data-path="parallel-computing.html"><a href="parallel-computing.html#fundamentals"><i class="fa fa-check"></i><b>4.4</b> Fundamentals</a><ul>
<li class="chapter" data-level="4.4.1" data-path="parallel-computing.html"><a href="parallel-computing.html#types-of-parallelisms"><i class="fa fa-check"></i><b>4.4.1</b> Types of parallelisms</a></li>
<li class="chapter" data-level="4.4.2" data-path="parallel-computing.html"><a href="parallel-computing.html#what-you-need-to-know-about-hardware"><i class="fa fa-check"></i><b>4.4.2</b> What you need to know about Hardware</a></li>
<li class="chapter" data-level="4.4.3" data-path="parallel-computing.html"><a href="parallel-computing.html#hpc-in-r"><i class="fa fa-check"></i><b>4.4.3</b> HPC in R</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="parallel-computing.html"><a href="parallel-computing.html#parallel-computing-in-r"><i class="fa fa-check"></i><b>4.5</b> Parallel computing in R</a><ul>
<li class="chapter" data-level="4.5.1" data-path="parallel-computing.html"><a href="parallel-computing.html#the-parallel-package"><i class="fa fa-check"></i><b>4.5.1</b> The parallel package</a></li>
<li class="chapter" data-level="4.5.2" data-path="parallel-computing.html"><a href="parallel-computing.html#parallel-example-1-parallel-rng"><i class="fa fa-check"></i><b>4.5.2</b> parallel example 1: Parallel RNG</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="parallel-computing.html"><a href="parallel-computing.html#parallel-example-2-simulating-pi"><i class="fa fa-check"></i><b>4.6</b> parallel example 2: Simulating <span class="math inline">\(\pi\)</span></a><ul>
<li class="chapter" data-level="4.6.1" data-path="parallel-computing.html"><a href="parallel-computing.html#speedup-things-with-rcpp-openmp"><i class="fa fa-check"></i><b>4.6.1</b> Speedup things with Rcpp + OpenMP</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>5</b> Testing</a></li>
<li class="chapter" data-level="6" data-path="profile-benchmark.html"><a href="profile-benchmark.html"><i class="fa fa-check"></i><b>6</b> Profiling and benchmarking</a><ul>
<li class="chapter" data-level="6.1" data-path="profile-benchmark.html"><a href="profile-benchmark.html#introduction-1"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="profile-benchmark.html"><a href="profile-benchmark.html#profiling"><i class="fa fa-check"></i><b>6.2</b> Profiling</a><ul>
<li class="chapter" data-level="6.2.1" data-path="profile-benchmark.html"><a href="profile-benchmark.html#troubleshooting"><i class="fa fa-check"></i><b>6.2.1</b> Troubleshooting</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="profile-benchmark.html"><a href="profile-benchmark.html#benchmarking"><i class="fa fa-check"></i><b>6.3</b> Benchmarking</a><ul>
<li class="chapter" data-level="6.3.1" data-path="profile-benchmark.html"><a href="profile-benchmark.html#slow-code"><i class="fa fa-check"></i><b>6.3.1</b> Slow code</a></li>
<li class="chapter" data-level="6.3.2" data-path="profile-benchmark.html"><a href="profile-benchmark.html#fast-code---microbenchmarking"><i class="fa fa-check"></i><b>6.3.2</b> Fast code - microbenchmarking</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="profile-benchmark.html"><a href="profile-benchmark.html#additional-resources"><i class="fa fa-check"></i><b>6.4</b> Additional resources</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="hpc.html"><a href="hpc.html"><i class="fa fa-check"></i><b>7</b> HPC</a><ul>
<li class="chapter" data-level="7.1" data-path="hpc.html"><a href="hpc.html#keep-yor-library-organized"><i class="fa fa-check"></i><b>7.1</b> Keep yor library organized</a></li>
<li class="chapter" data-level="7.2" data-path="hpc.html"><a href="hpc.html#dont-hijack-nodes"><i class="fa fa-check"></i><b>7.2</b> Don’t hijack nodes</a></li>
<li class="chapter" data-level="7.3" data-path="hpc.html"><a href="hpc.html#keep-tempfiles-where-they-belong"><i class="fa fa-check"></i><b>7.3</b> Keep tempfiles where they belong</a></li>
<li class="chapter" data-level="7.4" data-path="hpc.html"><a href="hpc.html#use-links-and-not-hard-copies-of-large-data"><i class="fa fa-check"></i><b>7.4</b> Use links and not hard copies of large data</a></li>
<li class="chapter" data-level="7.5" data-path="hpc.html"><a href="hpc.html#be-mindful-about-special-configs-for-r-packages"><i class="fa fa-check"></i><b>7.5</b> Be mindful about special configs for R packages</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">USC biostats R Handbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hpc" class="section level1">
<h1><span class="header-section-number">7</span> HPC</h1>
<p>Some important points to consider while using HPC in R</p>
<div id="keep-yor-library-organized" class="section level2">
<h2><span class="header-section-number">7.1</span> Keep yor library organized</h2>
<p>In a lot of setups the “Desk” space available (a.k.a. home) in HPC clusters is
rather small. In such cases it makes sense to keep permanent files elsewhere.
This applies directly to the R library (where R packages live).</p>
<p><strong>The simple tip is</strong> Keep all your good stuff in a folder where you have a large
storage (rather permanent) space, and create a symbolic link to it at home. Here
is an example setup:</p>
<pre class="shell"><code>$ cd /where/i/have/space/
$ mkdir Rlibs
$ cd ~
$ ln -s R /where/i/have/space/Rlibs</code></pre>
<p>This way, whenever you install an R package, by default it will be installed
in your <code>/where/i/have/space/Rlibs</code> folder, but it is easy to access from any
R session sin R will check (by default) your home directory for an <code>R</code> folder.</p>
<p>In the particular case of USC, home directories (not to be confounded with
project directories) are rather small, 1GB last time I checked, which makes
sense as you shouldn’t be using the home directory for storage but for script
submission.</p>
</div>
<div id="dont-hijack-nodes" class="section level2">
<h2><span class="header-section-number">7.2</span> Don’t hijack nodes</h2>
<p>A lot of times people tend to request resources by the node, which is a terrible
(not very nice) practice. Instead of specifying how many nodes you want to use,
tell the job-scheduler how many tasks (or cores) you request.</p>
<p>In the case of Slurm, we can use the following setup:</p>
<pre class="shell"><code>#SBATCH ntasks=1
#SBATCH cpus-per-task=10</code></pre>
<p>The previous code is advising<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> Slurm to allocate 10 cores for the job
to be submitted. Another way to be more efficient is using Arrays, e.g.</p>
<pre class="shell"><code>#SBATCH array=1-10
#SBATCH ntasks=1
#SBATCH cpus-per-task=4</code></pre>
<p>This code tells Slurm that this job should be repeated 10 times with the same
setup (10 jobs each with a single task, but each task using 4 processors,
i.e. 40 cores). The key is in the environment variable <code>SLURM_ARRAY_TASK_ID</code> which
will take values 1 through 10 at each job, so the user can specify what to do
in each one of the jobs, for example, in R:</p>
<pre class="sourceCode r"><code class="sourceCode r">ARRAY_ID &lt;-<span class="st"> </span><span class="kw">Sys.getenv</span>(<span class="st">&quot;SLURM_ARRAY_TASK_ID&quot;</span>)
dat &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">sprintf</span>(<span class="st">&quot;path/to/a/file/file-number-%d.rds&quot;</span>, ARRAY_ID))</code></pre>
</div>
<div id="keep-tempfiles-where-they-belong" class="section level2">
<h2><span class="header-section-number">7.3</span> Keep tempfiles where they belong</h2>
<p>TL;DR use the stagging or tmp filesystems in your cluster to store temporal
files. Only files that will be used for analysis (results) should be stored
in project space.</p>
<p>This means that any by-product like log files, auxiliar files, etc. should be
kept in those places</p>
</div>
<div id="use-links-and-not-hard-copies-of-large-data" class="section level2">
<h2><span class="header-section-number">7.4</span> Use links and not hard copies of large data</h2>
<p>A very common and bad practice is to keep copies of large files duplicated accross
projects. A good practice is to have symbolic links to whatever large data set
you are planning to use instead. For example, suppose that we have the following
file</p>
<pre class="shell"><code>/path/to/a/very/large/big-dataset.csv</code></pre>
<p>Instead of creating a copy in your project directory, you should consider doing
the following instead:</p>
<pre class="shell"><code>$ mkdir data-raw
$ cd data-raw
$ ln -s big-dataset.csv /path/to/a/very/large/big-dataset.csv</code></pre>
<p>System managers (and your future self), will appreciate it.</p>
</div>
<div id="be-mindful-about-special-configs-for-r-packages" class="section level2">
<h2><span class="header-section-number">7.5</span> Be mindful about special configs for R packages</h2>
<p>Some times R packages installed from source have flags that can cause your code
to blow in a HPC cluster setting. One recent example of this is the R package
<code>rstan</code>. In this case, some flags passed to the compiler made the package to
fine-tune the compilation to the current machine, which causes problems when
your cluster is actually heterogenous in terms of nodes setup.</p>

</div>
</div>












<div class="footnotes">
<hr />
<ol start="3">
<li id="fn3"><p>In Slurm, setting the number of cores or memory required for a particular
job is actually an advice since the job-scheduler will try to allocate your job
in a set of nodes (or single node) that hopefully goes along with the requirement.
There are ways to be more strict about some of these, but is not recomended to
follow that path.<a href="hpc.html#fnref3" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="profile-benchmark.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/06-hpc.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["Handbook.pdf", "Handbook.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
