<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>6 Profiling and benchmarking | USC biostats R Handbook</title>
  <meta name="description" content="Working document description best practices and coding standard used in the USC Biostats department.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="6 Profiling and benchmarking | USC biostats R Handbook" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Working document description best practices and coding standard used in the USC Biostats department." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Profiling and benchmarking | USC biostats R Handbook" />
  
  <meta name="twitter:description" content="Working document description best practices and coding standard used in the USC Biostats department." />
  

<meta name="author" content="Emil Hvitfeldt">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="testing.html">
<link rel="next" href="hpc.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Handbook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#add-chapter"><i class="fa fa-check"></i><b>1.1</b> add chapter</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#editing-a-chapter"><i class="fa fa-check"></i><b>1.2</b> editing a chapter</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#compile-handbook"><i class="fa fa-check"></i><b>1.3</b> compile handbook</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="coding-standards.html"><a href="coding-standards.html"><i class="fa fa-check"></i><b>2</b> Coding Standards</a><ul>
<li class="chapter" data-level="2.1" data-path="coding-standards.html"><a href="coding-standards.html#general-overview"><i class="fa fa-check"></i><b>2.1</b> General overview</a></li>
<li class="chapter" data-level="2.2" data-path="coding-standards.html"><a href="coding-standards.html#helpful-suggestions"><i class="fa fa-check"></i><b>2.2</b> Helpful suggestions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="building-a-r-package.html"><a href="building-a-r-package.html"><i class="fa fa-check"></i><b>3</b> Building a R package</a><ul>
<li class="chapter" data-level="3.1" data-path="building-a-r-package.html"><a href="building-a-r-package.html#motivation"><i class="fa fa-check"></i><b>3.1</b> Motivation</a></li>
<li class="chapter" data-level="3.2" data-path="building-a-r-package.html"><a href="building-a-r-package.html#preparation"><i class="fa fa-check"></i><b>3.2</b> Preparation</a><ul>
<li class="chapter" data-level="3.2.1" data-path="building-a-r-package.html"><a href="building-a-r-package.html#naming-your-r-package"><i class="fa fa-check"></i><b>3.2.1</b> Naming your R package</a></li>
<li class="chapter" data-level="3.2.2" data-path="building-a-r-package.html"><a href="building-a-r-package.html#checking"><i class="fa fa-check"></i><b>3.2.2</b> Checking</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="building-a-r-package.html"><a href="building-a-r-package.html#minimal-r-package"><i class="fa fa-check"></i><b>3.3</b> Minimal R Package</a></li>
<li class="chapter" data-level="3.4" data-path="building-a-r-package.html"><a href="building-a-r-package.html#additional-components"><i class="fa fa-check"></i><b>3.4</b> Additional Components</a><ul>
<li class="chapter" data-level="3.4.1" data-path="building-a-r-package.html"><a href="building-a-r-package.html#r-code-r"><i class="fa fa-check"></i><b>3.4.1</b> R code <code>R/</code></a></li>
<li class="chapter" data-level="3.4.2" data-path="building-a-r-package.html"><a href="building-a-r-package.html#documentation"><i class="fa fa-check"></i><b>3.4.2</b> Documentation</a></li>
<li class="chapter" data-level="3.4.3" data-path="building-a-r-package.html"><a href="building-a-r-package.html#dependencies"><i class="fa fa-check"></i><b>3.4.3</b> Dependencies</a></li>
<li class="chapter" data-level="3.4.4" data-path="building-a-r-package.html"><a href="building-a-r-package.html#license"><i class="fa fa-check"></i><b>3.4.4</b> License</a></li>
<li class="chapter" data-level="3.4.5" data-path="building-a-r-package.html"><a href="building-a-r-package.html#readme"><i class="fa fa-check"></i><b>3.4.5</b> README</a></li>
<li class="chapter" data-level="3.4.6" data-path="building-a-r-package.html"><a href="building-a-r-package.html#tests"><i class="fa fa-check"></i><b>3.4.6</b> Tests</a></li>
<li class="chapter" data-level="3.4.7" data-path="building-a-r-package.html"><a href="building-a-r-package.html#data"><i class="fa fa-check"></i><b>3.4.7</b> Data</a></li>
<li class="chapter" data-level="3.4.8" data-path="building-a-r-package.html"><a href="building-a-r-package.html#compiledcode"><i class="fa fa-check"></i><b>3.4.8</b> Compiled code</a></li>
<li class="chapter" data-level="3.4.9" data-path="building-a-r-package.html"><a href="building-a-r-package.html#vignettes"><i class="fa fa-check"></i><b>3.4.9</b> vignettes</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="building-a-r-package.html"><a href="building-a-r-package.html#resources"><i class="fa fa-check"></i><b>3.5</b> Resources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="parallel-computing.html"><a href="parallel-computing.html"><i class="fa fa-check"></i><b>4</b> Parallel computing</a><ul>
<li class="chapter" data-level="4.1" data-path="parallel-computing.html"><a href="parallel-computing.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="parallel-computing.html"><a href="parallel-computing.html#what-is-parallel-computing-anyway"><i class="fa fa-check"></i><b>4.2</b> What is parallel computing, anyway?</a></li>
<li class="chapter" data-level="4.3" data-path="parallel-computing.html"><a href="parallel-computing.html#when-is-it-a-good-idea"><i class="fa fa-check"></i><b>4.3</b> When is it a good idea?</a></li>
<li class="chapter" data-level="4.4" data-path="parallel-computing.html"><a href="parallel-computing.html#fundamentals"><i class="fa fa-check"></i><b>4.4</b> Fundamentals</a><ul>
<li class="chapter" data-level="4.4.1" data-path="parallel-computing.html"><a href="parallel-computing.html#types-of-parallelisms"><i class="fa fa-check"></i><b>4.4.1</b> Types of parallelisms</a></li>
<li class="chapter" data-level="4.4.2" data-path="parallel-computing.html"><a href="parallel-computing.html#what-you-need-to-know-about-hardware"><i class="fa fa-check"></i><b>4.4.2</b> What you need to know about Hardware</a></li>
<li class="chapter" data-level="4.4.3" data-path="parallel-computing.html"><a href="parallel-computing.html#hpc-in-r"><i class="fa fa-check"></i><b>4.4.3</b> HPC in R</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="parallel-computing.html"><a href="parallel-computing.html#parallel-computing-in-r"><i class="fa fa-check"></i><b>4.5</b> Parallel computing in R</a><ul>
<li class="chapter" data-level="4.5.1" data-path="parallel-computing.html"><a href="parallel-computing.html#the-parallel-package"><i class="fa fa-check"></i><b>4.5.1</b> The parallel package</a></li>
<li class="chapter" data-level="4.5.2" data-path="parallel-computing.html"><a href="parallel-computing.html#parallel-example-1-parallel-rng"><i class="fa fa-check"></i><b>4.5.2</b> parallel example 1: Parallel RNG</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="parallel-computing.html"><a href="parallel-computing.html#parallel-example-2-simulating-pi"><i class="fa fa-check"></i><b>4.6</b> parallel example 2: Simulating <span class="math inline">\(\pi\)</span></a><ul>
<li class="chapter" data-level="4.6.1" data-path="parallel-computing.html"><a href="parallel-computing.html#speedup-things-with-rcpp-openmp"><i class="fa fa-check"></i><b>4.6.1</b> Speedup things with Rcpp + OpenMP</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>5</b> Testing</a></li>
<li class="chapter" data-level="6" data-path="profile-benchmark.html"><a href="profile-benchmark.html"><i class="fa fa-check"></i><b>6</b> Profiling and benchmarking</a><ul>
<li class="chapter" data-level="6.1" data-path="profile-benchmark.html"><a href="profile-benchmark.html#introduction-1"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="profile-benchmark.html"><a href="profile-benchmark.html#profiling"><i class="fa fa-check"></i><b>6.2</b> Profiling</a><ul>
<li class="chapter" data-level="6.2.1" data-path="profile-benchmark.html"><a href="profile-benchmark.html#troubleshooting"><i class="fa fa-check"></i><b>6.2.1</b> Troubleshooting</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="profile-benchmark.html"><a href="profile-benchmark.html#benchmarking"><i class="fa fa-check"></i><b>6.3</b> Benchmarking</a><ul>
<li class="chapter" data-level="6.3.1" data-path="profile-benchmark.html"><a href="profile-benchmark.html#slow-code"><i class="fa fa-check"></i><b>6.3.1</b> Slow code</a></li>
<li class="chapter" data-level="6.3.2" data-path="profile-benchmark.html"><a href="profile-benchmark.html#fast-code---microbenchmarking"><i class="fa fa-check"></i><b>6.3.2</b> Fast code - microbenchmarking</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="profile-benchmark.html"><a href="profile-benchmark.html#additional-resources"><i class="fa fa-check"></i><b>6.4</b> Additional resources</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="hpc.html"><a href="hpc.html"><i class="fa fa-check"></i><b>7</b> HPC</a><ul>
<li class="chapter" data-level="7.1" data-path="hpc.html"><a href="hpc.html#keep-yor-library-organized"><i class="fa fa-check"></i><b>7.1</b> Keep yor library organized</a></li>
<li class="chapter" data-level="7.2" data-path="hpc.html"><a href="hpc.html#dont-hijack-nodes"><i class="fa fa-check"></i><b>7.2</b> Don’t hijack nodes</a></li>
<li class="chapter" data-level="7.3" data-path="hpc.html"><a href="hpc.html#keep-tempfiles-where-they-belong"><i class="fa fa-check"></i><b>7.3</b> Keep tempfiles where they belong</a></li>
<li class="chapter" data-level="7.4" data-path="hpc.html"><a href="hpc.html#use-links-and-not-hard-copies-of-large-data"><i class="fa fa-check"></i><b>7.4</b> Use links and not hard copies of large data</a></li>
<li class="chapter" data-level="7.5" data-path="hpc.html"><a href="hpc.html#be-mindful-about-special-configs-for-r-packages"><i class="fa fa-check"></i><b>7.5</b> Be mindful about special configs for R packages</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">USC biostats R Handbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="profile-benchmark" class="section level1">
<h1><span class="header-section-number">6</span> Profiling and benchmarking</h1>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">6.1</span> Introduction</h2>
<p>This chapter will introduce the the concepts of profiling and benchmarking. These concepts are universal withing programming . This chapter will focus on its practical implementation and usage in the R programming language.</p>
<p>The overall goal of these techniques is to measure the performance of the code you have written. Remember this is a measure of speed, not a measure of correctness.</p>
</div>
<div id="profiling" class="section level2">
<h2><span class="header-section-number">6.2</span> Profiling</h2>
<p>Profiling is the act of measuring the run-time of each line of code you have run. Knowing where the time is being spend in your code is beneficial as it is a good indication of where you should spend your time optimizing. In general you want to look for small areas that take up most of the time (also called a “bottleneck”) and focus on those before other parts. There is little reason to spend time optimizing a piece of code that only take up 0.1% of the time when you could work at a piece that takes up 70% of the time.</p>
<p>We will use the the <a href="https://rstudio.github.io/profvis/">profvis</a> package to do profiling. It have a couple of different ways of interacting. In the first one you load the <strong>profvis</strong> package and then you wrap the code you want to profile in <code>profvis({</code> and <code>})</code> as shown below show below.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(profvis)

<span class="kw">profvis</span>({
  data &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="fl">1e7</span>)
  <span class="co"># Three different ways of getting the square root</span>
  square_root &lt;-<span class="st"> </span><span class="kw">sqrt</span>(data)
  square_root &lt;-<span class="st"> </span>data <span class="op">^</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>)
  square_root &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="dv">1</span>) <span class="op">^</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(data))
})</code></pre>
<p>Another way if you are using the Rstudio IDE, comes from the navigation bar where you can access the profiling tool.</p>
<div class="figure"><span id="fig:unnamed-chunk-10"></span>
<img src="screenshots/profiling-benchmark/navbar.png" alt="Profile location in Rstudio IDE navigation bar." width="100%" />
<p class="caption">
Figure 6.1: Profile location in Rstudio IDE navigation bar.
</p>
</div>
<p>Clicking this tab reveals the following actions:</p>
<ul>
<li>“Profile selected line(s)”</li>
<li>“Start profiling” &amp; “Stop profiling”</li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-11"></span>
<img src="screenshots/profiling-benchmark/profile-submenu.png" alt="Profiling actions." width="50%" />
<p class="caption">
Figure 6.2: Profiling actions.
</p>
</div>
<p>Being able to profile selected lines of code is great if you have a short and compact piece of code that easily can be highlighted and tested.</p>
<p>On the other hand is the ability start and stop the profiling whenever you want a powerful tool. In addition to being able to profile code from different areas, you are also able to stop profiling before the code is done executing, which you aren’t able to in the previous 2 methods. This is useful if you want to profile a snapshot of a long-running simulation as it can have very consistent behavior since it is running the same thing millions of time.</p>
<p>No matter which of the three way you do your profile you will be presented with a page with a frame-graph</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-12"></span>
<img src="screenshots/profiling-benchmark/flamegraph.png" alt="profvis output showing source on top and flame graph below." width="75%" />
<p class="caption">
Figure 6.3: profvis output showing source on top and flame graph below.
</p>
</div>
<p>This interactive panel shows how much time and memory is being spend on each line of code. From here you should be able to identify Another useful view can be found by clicking on the “data” tab at the top. This shows how long time is being spend in each expression. We can see in this example that the power operator <code>^</code> is taking the majority of the time.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-13"></span>
<img src="screenshots/profiling-benchmark/dataview.png" alt="profvis data view showcases results by expresion in stead of by line." width="75%" />
<p class="caption">
Figure 6.4: profvis data view showcases results by expresion in stead of by line.
</p>
</div>
<div id="troubleshooting" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Troubleshooting</h3>
<p>Sometimes when you are using <strong>profvis</strong> you will see the error</p>
<pre><code>Error in parse_rprof(prof_output, expr_source) : 
  No parsing data available. Maybe your function was too fast?</code></pre>
<p>This is because your code finished running before profvis was able to detect it. This might feel like good news, but it can make it difficult to profile very fast functions. To profile a fast function you simply let it run a lot of times. This can easily be done by putting it inside a for-loop. You change this</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profvis</span>({
  data &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">7</span>, <span class="dv">2</span>)

  <span class="kw">super_fast_function</span>(data)
})</code></pre>
<p>to</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profvis</span>({
  data &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">7</span>, <span class="dv">2</span>)

  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>) {
    <span class="kw">super_fast_function</span>(data)
  }
})</code></pre>
<p>where you increase the number until it is run enough for the profiler to catch it.</p>
</div>
</div>
<div id="benchmarking" class="section level2">
<h2><span class="header-section-number">6.3</span> Benchmarking</h2>
<p>Measuring how long something takes is a simple skill that will become invaluable once you start to focus on making your code faster. Simply put, if you can’t measure how fast something is you don’t know if it is going any faster. This section will be broken into 2 sections</p>
<ul>
<li>benchmarking slow code and,</li>
<li>benchmarking fast code.</li>
</ul>
<p>In this content slow is something that takes seconds, minutes, hours or more. It is a situation where you could use a conventional stopwatch. Fast is anything faster, it is used in the context where you have two pieces of code you think does the same and you want to find out which one is faster.</p>
<div id="slow-code" class="section level3">
<h3><span class="header-section-number">6.3.1</span> Slow code</h3>
<p>First we need to create a function to benchmark, here we will use this simple recursive formula for the fibonacci sequence. This function doesn’t scale well with <code>n</code> so it will be perfect for these examples.</p>
<pre class="sourceCode r"><code class="sourceCode r">fibonacci &lt;-<span class="st"> </span><span class="cf">function</span>(n) {
  <span class="cf">if</span>(n <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
    <span class="kw">return</span>(<span class="dv">0</span>)
  }
  <span class="cf">if</span>(n <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {
    <span class="kw">return</span>(<span class="dv">1</span>)
  }
  <span class="kw">fibonacci</span>(n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">fibonacci</span>(n <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)
}</code></pre>
<p>Using <code>system.time()</code> is classic way to measure how long something takes, simple wrap the code you want to time between <code>system.time({</code> and <code>})</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  <span class="kw">fibonacci</span>(<span class="dv">32</span>)
  })</code></pre>
<pre><code>##    user  system elapsed 
##   2.740   0.000   2.744</code></pre>
<p>The first two numbers are the are the total user and system CPU times of the current R process and any child processes on which it has waited, and the third entry is the ‘real’ elapsed time since the process was started. An alternative with the same functionality from the <a href="http://bench.r-lib.org">bench</a> package is the function <code>system_time()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(bench)
<span class="kw">system_time</span>({
  <span class="kw">fibonacci</span>(<span class="dv">32</span>)
  })</code></pre>
<pre><code>## process    real 
##   2.67s   2.67s</code></pre>
<p>where the two values are</p>
<ul>
<li>process - The process CPU usage of the expression evaluation.</li>
<li>real - The wall clock time of the expression evaluation.</li>
</ul>
<p>Another great tool is the <a href="http://collectivemedia.github.io/tictoc/">tictoc</a> package. Simply call <code>tic()</code> when to start recording and <code>toc()</code> to end recording.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tictoc)
<span class="kw">tic</span>()
x &lt;-<span class="st"> </span><span class="kw">fibonacci</span>(<span class="dv">32</span>)
<span class="kw">toc</span>()</code></pre>
<pre><code>## 2.808 sec elapsed</code></pre>
<p>In addition does this package extend the timing functionality in such a way that we are able to measure times in nested context. In the following example we are generating some data and fitting a model. Calling <code>tic()</code> another time before the <code>toc()</code> allows us to measure subsections of the whole.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tictoc)
<span class="kw">tic</span>(<span class="st">&quot;Total&quot;</span>)
 <span class="kw">tic</span>(<span class="st">&quot;Data Generation&quot;</span>)
 X &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(<span class="dv">5000</span> <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>), <span class="dv">5000</span>, <span class="dv">1000</span>)
 b &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>, <span class="dv">1000</span>)
 y &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span>X <span class="op">%*%</span><span class="st"> </span>b <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">5000</span>)
 <span class="kw">toc</span>()
 
 <span class="kw">tic</span>(<span class="st">&quot;Model Fitting&quot;</span>)
 model &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>X)
 <span class="kw">toc</span>()
<span class="kw">toc</span>()</code></pre>
<pre><code>## Data Generation: 0.407 sec elapsed
## Model Fitting: 4.796 sec elapsed
## Total: 5.206 sec elapsed</code></pre>
<p>This can be useful if you want to be able to time the overall script as well as parts of it. Notice how each timing is named.</p>
</div>
<div id="fast-code---microbenchmarking" class="section level3">
<h3><span class="header-section-number">6.3.2</span> Fast code - microbenchmarking</h3>
<p>Here we will look at the what happens when we want to compare two expressions to see which one is faster. We will use the <strong>bench</strong> package again. Suppose we would like to determine the fastest way of calculating the variance of a selection of numbers. We use the <code>mark()</code> function from the <strong>bench</strong> and insert 2 or more expressions we would like to test against each other. These expressions are then run a lot of times and the summary statistics of the times are given as a result.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(bench)
x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1000</span>)

bench<span class="op">::</span><span class="kw">mark</span>(
  <span class="kw">var</span>(x),
  <span class="kw">cov</span>(x, x)
)</code></pre>
<pre><code>## # A tibble: 2 x 10
##   expression    min   mean median     max `itr/sec` mem_alloc  n_gc n_itr
##   &lt;chr&gt;      &lt;bch:&gt; &lt;bch:&gt; &lt;bch:&gt; &lt;bch:t&gt;     &lt;dbl&gt; &lt;bch:byt&gt; &lt;dbl&gt; &lt;int&gt;
## 1 var(x)      9.5µs 11.9µs 10.7µs 103.2µs    83963.    13.7KB     1  9999
## 2 cov(x, x)  19.5µs 22.1µs 21.5µs  77.9µs    45231.    47.6KB     4  9996
## # … with 1 more variable: total_time &lt;bch:tm&gt;</code></pre>
<p><code>mark()</code> also checks that all the expressions return the same output as a sanity check. Notice the units</p>
<ul>
<li>1 ms, then one thousand calls takes a second.</li>
<li>1 µs, then one million calls takes a second.</li>
<li>1 ns, then one billion calls takes a second.</li>
</ul>
</div>
</div>
<div id="additional-resources" class="section level2">
<h2><span class="header-section-number">6.4</span> Additional resources</h2>
<p><a href="https://adv-r.hadley.nz/perf-measure.html" class="uri">https://adv-r.hadley.nz/perf-measure.html</a><br />
Chapter on “Measuring performance” from Advanced R by Hadley Wickham. Covers more or less the same topics as this chapter but with more examples and greater details, great next step for reading.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="testing.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="hpc.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/05-profiling.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["Handbook.pdf", "Handbook.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
